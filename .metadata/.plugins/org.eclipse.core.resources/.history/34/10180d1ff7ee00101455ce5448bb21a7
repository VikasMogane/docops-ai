package com.docops.document.service;

import com.docops.document.entity.Document;
import com.docops.document.entity.DocumentChunk;
import com.docops.document.repository.DocumentChunkRepository;
import com.docops.document.repository.DocumentRepository;
import com.docops.document.util.PdfTextExtractor;
import com.docops.document.util.TextChunker;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import com.docops.document.workflow.DocumentStatus;

import java.io.File;
import java.nio.file.Files;
import java.time.Instant;
import java.util.List;

@Service
@RequiredArgsConstructor
public class DocumentProcessingService {

    private static final String STORAGE_DIR = "data/docs/";

    private final DocumentRepository documentRepository;
    private final DocumentChunkRepository chunkRepository;

    public Document processUpload(
            Long orgId,
            Long userId,
            MultipartFile file
    ) {

        try {
            // 1. Save metadata
            Document doc = new Document();
            doc.setOrgId(orgId);
            doc.setUploadedBy(userId);
            doc.setFileName(file.getOriginalFilename());
            doc.setContentType(file.getContentType());
            doc.setStatus(DocumentStatus.UPLOADED); 
            doc.setCreatedAt(Instant.now());

            doc = documentRepository.save(doc);

            // 2. Store file on disk
            File storageFile = new File(STORAGE_DIR + doc.getId() + ".pdf");
            Files.createDirectories(storageFile.getParentFile().toPath());
            file.transferTo(storageFile);

            // 3. Extract text
            String text = PdfTextExtractor.extractText(storageFile);

            // 4. Chunk text
            List<String> chunks = TextChunker.chunk(text);

            // 5. Save chunks
            for (String chunk : chunks) {
                DocumentChunk dc = new DocumentChunk();
                dc.setDocumentId(doc.getId());
                dc.setContent(chunk);
                chunkRepository.save(dc);
            }

            // 6. Update status
            doc.setStatus("PROCESSED");
            return documentRepository.save(doc);

        } catch (Exception e) {
            throw new RuntimeException("Document processing failed", e);
        }
    }
}
